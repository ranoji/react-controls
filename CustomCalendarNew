// CustomCalendar.js
import React, { useState } from "react";
import {
  Box,
  Button,
  IconButton,
  Typography,
  Grid,
  Popover,
  TextField,
  Stack,
} from "@mui/material";
import { ArrowBack, ArrowForward, Today } from "@mui/icons-material";
import HolidayIcon from "@mui/icons-material/Event";
import IndexIcon from "@mui/icons-material/Assessment";
import dayjs from "dayjs";
import localizedFormat from "dayjs/plugin/localizedFormat";
dayjs.extend(localizedFormat);

const events = {
  exchangeHolidays: [
    { date: "2024-06-14", name: "Flag Day" },
    { date: "2024-07-04", name: "Independence Day" },
    { date: "2024-12-25", name: "Christmas Day" },
  ],
  policies: [
    { date: "2024-06-10", name: "Policy Review" },
    { date: "2024-11-20", name: "Policy Update" },
  ],
  indices: [
    { date: "2024-08-01", name: "Index Update" },
    { date: "2024-06-15", name: "New Index Release" },
  ],
};

const CustomCalendar = () => {
  const [currentDate, setCurrentDate] = useState(dayjs());
  const [anchorEl, setAnchorEl] = useState(null);
  const [selectedDayDetails, setSelectedDayDetails] = useState([]);
  const today = dayjs();

  const startDay = currentDate.startOf("month").startOf("week");
  const endDay = currentDate.endOf("month").endOf("week");

  const days = [];
  let day = startDay;

  while (day.isBefore(endDay.add(1, "day"))) {
    days.push(day);
    // day = day.add(1, "day");
  }

  const handlePrevMonth = () => {
    setCurrentDate(currentDate.subtract(1, "month"));
  };

  const handleNextMonth = () => {
    setCurrentDate(currentDate.add(1, "month"));
  };

  const handleToday = () => {
    setCurrentDate(today);
  };

  const handleDateChange = (event) => {
    const date = dayjs(event.target.value);
    if (date.isValid()) {
      setCurrentDate(date.startOf("month"));
      setAnchorEl(null);
    }
  };

  const handleDateClick = (event) => {
    setAnchorEl(event.currentTarget);
  };

  const handleClose = () => {
    setAnchorEl(null);
  };

  const getEventsForDay = (date) => {
    const exchangeHoliday = events.exchangeHolidays.find((event) =>
      dayjs(event.date).isSame(date, "day")
    );
    const policy = events.policies.find((event) =>
      dayjs(event.date).isSame(date, "day")
    );
    const index = events.indices.find((event) =>
      dayjs(event.date).isSame(date, "day")
    );
    return { exchangeHoliday, policy, index };
  };

  const renderDay = (day) => {
    const { exchangeHoliday, policy, index } = getEventsForDay(day);
    const isToday = day.isSame(today, "day");

    let bgColor = "white";
    if (policy) bgColor = "orange";
    if (isToday) bgColor = "lightgreen";

    return (
      <Box
        key={day.format("YYYY-MM-DD")}
        sx={{
          padding: 1,
          backgroundColor: bgColor,
          border: isToday ? "1px solid green" : "0.5px solid grey",
          height: "60px",
          display: "flex",
          flexDirection: "column",
          alignItems: "flex-end",
          justifyContent: "space-between",
          cursor: "pointer",
          position: "relative",
        }}
        onClick={() =>
          setSelectedDayDetails(
            [exchangeHoliday, policy, index].filter(Boolean)
          )
        }
      >
        <Typography
          variant="body2"
          sx={{ position: "absolute", top: 0, right: 0, m: 1 }}
        >
          {day.format("D")}
        </Typography>
        <Box
          display="flex"
          justifyContent="center"
          alignItems="center"
          flexDirection="column"
        >
          {exchangeHoliday && <HolidayIcon fontSize="small" />}
          {index && <IndexIcon fontSize="small" />}
        </Box>
      </Box>
    );
  };

  return (
    <Box sx={{ margin: "0 auto", width: "80%" }}>
      <Box
        display="flex"
        justifyContent="space-between"
        alignItems="center"
        mb={2}
      >
        {/* Legends */}
        <Box display="flex" alignItems="center">
          <Box display="flex" alignItems="center" mr={2}>
            <Box
              sx={{
                width: 20,
                height: 20,
                backgroundColor: "lightblue",
                borderRadius: "50%",
                marginRight: 1,
              }}
            />
            <Typography>Exchange Holiday</Typography>
          </Box>
          <Box display="flex" alignItems="center">
            <Box
              sx={{
                width: 20,
                height: 20,
                backgroundColor: "orange",
                borderRadius: "50%",
                marginRight: 1,
              }}
            />
            <Typography>Policy</Typography>
          </Box>
        </Box>

        {/* Month/Year and Navigation */}
        <Box display="flex" justifyContent="center" alignItems="center">
          <IconButton onClick={handlePrevMonth}>
            <ArrowBack />
          </IconButton>
          <Typography
            variant="h6"
            onClick={handleDateClick}
            sx={{ cursor: "pointer" }}
          >
            {currentDate.format("MMMM YYYY")}
          </Typography>
          <Popover
            open={Boolean(anchorEl)}
            anchorEl={anchorEl}
            onClose={handleClose}
            anchorOrigin={{
              vertical: "bottom",
              horizontal: "center",
            }}
            sx={{ p: 2 }}
          >
            <Box p={1}>
              <TextField
                type="month"
                value={currentDate.format("YYYY-MM")}
                onChange={handleDateChange}
                fullWidth
              />
            </Box>
          </Popover>
          <IconButton onClick={handleNextMonth}>
            <ArrowForward />
          </IconButton>
        </Box>

        {/* Today Button */}
        <Button
          sx={{
            boxShadow: "none",
            "&:hover": {
              backgroundColor: "skyblue",
              boxShadow: "none",
              border: "",
            },
          }}
          onClick={handleToday}
          startIcon={<Today />}
        >
          Today
        </Button>
      </Box>

      <Grid container spacing={0}>
        {["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map((day) => (
          <Grid item xs={1.714} key={day}>
            <Box sx={{ textAlign: "center" }}>
              <Typography>{day}</Typography>
            </Box>
          </Grid>
        ))}
      </Grid>
      <Grid container spacing={0}>
        {days.map((day) => (
          <Grid item xs={1.714} key={day.format("YYYY-MM-DD")}>
            {renderDay(day)}
          </Grid>
        ))}
      </Grid>
      {selectedDayDetails.length > 0 && (
        <Box mt={2}>
          <Typography variant="h6">Events on Selected Day:</Typography>
          {selectedDayDetails.map((event, index) => (
            <Box key={index} display="flex" alignItems="center" mb={1}>
              {event.name === "Holiday" ? (
                <HolidayIcon fontSize="small" sx={{ mr: 0.5 }} />
              ) : (
                <IndexIcon fontSize="small" sx={{ mr: 0.5 }} />
              )}
              <Typography>{event.name}</Typography>
            </Box>
          ))}
        </Box>
      )}
    </Box>
  );
};

export default CustomCalendar;
